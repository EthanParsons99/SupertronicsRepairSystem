@model SupertronicsRepairSystem.ViewModels.Technician.TrackSerialNumberViewModel
@{
    ViewData["Title"] = "Track Serial Number";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <!-- Page Header -->
            <div class="mb-4 fade-in">
                <h1 class="display-6 fw-bold mb-2" style="color: var(--primary-blue);">
                    @ViewData["Title"]
                </h1>
                <p style="color: var(--secondary-text);">Enter a serial number to check its repair history.</p>
            </div>

            <!-- Search Card -->
            <div class="card slide-in-left">
                <div class="card-header">
                    <h5 class="mb-0">
                        Serial Number Lookup
                    </h5>
                </div>
                <div class="card-body">
                    <form asp-action="TrackSerialNumber" method="post">
                        <div class="mb-3">
                            <label asp-for="SerialNumberToSearch" class="form-label"></label>
                            <div class="input-group">
                                <input asp-for="SerialNumberToSearch" class="form-control form-control-lg" placeholder="Enter serial number..." />
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="bi bi-search me-2"></i>Search Device
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Results Section -->
            @if (Model.SearchPerformed)
            {
                <div class="mt-4 slide-in-right">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0 d-flex align-items-center">
                                Repair History for "@Model.SerialNumberToSearch"
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            @if (Model.FoundJobs.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-striped mb-0">
                                        <thead class="bg-primary">
                                            <tr>
                                                <th class="ps-3">Job ID</th>
                                                <th>Device</th>
                                                <th>Customer</th>
                                                <th>Date Received</th>
                                                <th>Status</th>
                                                <th class="text-center">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var job in Model.FoundJobs.OrderByDescending(j => j.DateReceived))
                                            {
                                                <tr>
                                                    <td class="ps-3 fw-semibold">#@(job.Id?.Substring(0, 6).ToUpper() ?? "N/A")</td>
                                                    <td>@job.ItemModel</td>
                                                    <td>@job.CustomerName</td>
                                                    <td>@job.DateReceived.ToDateTime().ToString("yyyy-MM-dd")</td>
                                                    <td>@await Html.PartialAsync("_StatusBadge", job.Status)</td>
                                                    <td class="text-center">
                                                        <div class="btn-group btn-group-sm">
                                                            @if (job.Quotes != null && job.Quotes.Any())
                                                            {
                                                                var firstQuote = job.Quotes.First();
                                                                var partsJson = System.Text.Json.JsonSerializer.Serialize(firstQuote.QuoteParts);
                                                                <a href="#" class="btn btn-primary view-quote-btn" title="View Quote"
                                                                   data-job-id="@(job.Id?.Substring(0, 6).ToUpper() ?? "N/A")"
                                                                   data-parts-total="@firstQuote.PartsTotal.ToString("F2")"
                                                                   data-labor-total="@firstQuote.LaborTotal.ToString("F2")"
                                                                   data-sub-total="@firstQuote.SubTotal.ToString("F2")"
                                                                   data-tax-amount="@firstQuote.TaxAmount.ToString("F2")"
                                                                   data-total="@firstQuote.TotalAmount.ToString("F2")"
                                                                   data-parts='@Html.Raw(partsJson)'>
                                                                    <i class="bi bi-eye"></i>
                                                                </a>
                                                            }
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-4">
                                    <p class="text-muted mb-0">No repair history found for this serial number.</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>