@model SupertronicsRepairSystem.ViewModels.Technician.GenerateRepairQuoteViewModel
@{
    ViewData["Title"] = "Generate Repair Quote";
}

<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4 slide-in-left">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6 fw-bold mb-1" style="color: var(--primary-blue);">
                        Generate Repair Quote
                    </h1>
                    <p class="mb-0" style="color: var(--secondary-text);">Create a comprehensive repair quote for Job </p>
                </div>
                <div>
                    <a class="btn btn-secondary" asp-action="RepairJobs">
                        <i class="bi bi-arrow-left me-1"></i>Back to Jobs
                    </a>
                </div>
            </div>
        </div>
    </div>

    <form asp-action="GenerateRepairQuote" method="post" id="quoteForm">
    <input type="hidden" name="JobId" value="@(Model != null ? Model.JobId.ToString() : "")" />
        
        <div class="row">
            <!-- Left Column - Quote Details -->
            <div class="col-lg-8">
                
                <!-- Customer Information -->
                <div class="card mb-4 fade-in" style="animation-delay: 0.1s;">
                    <div class="card-header">
                        <h5 class="mb-0">
                            Customer Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label asp-for="CustomerName" class="form-label"></label>
                                <input asp-for="CustomerName" class="form-control" placeholder="John Smith" />
                                <span asp-validation-for="CustomerName" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="CustomerEmail" class="form-label"></label>
                                <input asp-for="CustomerEmail" class="form-control" type="email" placeholder="john@email.com" />
                                <span asp-validation-for="CustomerEmail" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="CustomerPhone" class="form-label"></label>
                                <input asp-for="CustomerPhone" class="form-control" type="tel" placeholder="+27 82 123 4567" />
                                <span asp-validation-for="CustomerPhone" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Device Information -->
                <div class="card mb-4 slide-in-left" style="animation-delay: 0.2s;">
                    <div class="card-header">
                        <h5 class="mb-0">
                            Device Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="DeviceName" class="form-label"></label>
                                <input asp-for="DeviceName" class="form-control" placeholder="iPhone 14 Pro" />
                                <span asp-validation-for="DeviceName" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="SerialNumber" class="form-label"></label>
                                <input asp-for="SerialNumber" class="form-control" placeholder="ABC123456789" />
                                <span asp-validation-for="SerialNumber" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="Brand" class="form-label"></label>
                                <input asp-for="Brand" class="form-control" placeholder="Apple" />
                                <span asp-validation-for="Brand" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="Model" class="form-label"></label>
                                <input asp-for="Model" class="form-control" placeholder="A2894" />
                                <span asp-validation-for="Model" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Problem Description -->
                <div class="card mb-4 fade-in" style="animation-delay: 0.3s;">
                    <div class="card-header">
                        <h5 class="mb-0">
                            Problem & Diagnosis
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <label asp-for="ProblemDescription" class="form-label"></label>
                                <textarea asp-for="ProblemDescription" class="form-control" rows="3" 
                                         placeholder="Describe the customer's reported issue..."></textarea>
                                <span asp-validation-for="ProblemDescription" class="text-danger"></span>
                            </div>
                            <div class="col-12">
                                <label asp-for="DiagnosisNotes" class="form-label"></label>
                                <textarea asp-for="DiagnosisNotes" class="form-control" rows="4" 
                                         placeholder="Your technical diagnosis and findings..."></textarea>
                                <span asp-validation-for="DiagnosisNotes" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Parts Required -->
                <div class="card mb-4 slide-in-right" style="animation-delay: 0.4s;">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                Required Parts
                            </h5>
                            <button type="button" class="btn btn-primary btn-sm" id="addPartBtn">
                                <i class="bi bi-plus me-1"></i>Add Part
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="partsContainer">
                            <!-- Parts will be added here -->
                        </div>
                        <div class="text-muted text-center py-3" id="noPartsMessage">
                            <i class="bi bi-info-circle me-2"></i>Click "Add Part" to include required parts in the quote
                        </div>
                    </div>
                </div>

                <!-- Labor Information -->
                <div class="card mb-4 fade-in" style="animation-delay: 0.5s;">
                    <div class="card-header">
                        <h5 class="mb-0">
                            Labor Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="LaborHours" class="form-label"></label>
                                <div class="input-group">
                                    <input asp-for="LaborHours" class="form-control" type="number" step="0.25" min="0.25" />
                                    <span class="input-group-text">hours</span>
                                </div>
                                <span asp-validation-for="LaborHours" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="LaborRate" class="form-label"></label>
                                <div class="input-group">
                                    <span class="input-group-text">R</span>
                                    <input asp-for="LaborRate" class="form-control" type="number" step="0.01" min="200" />
                                    <span class="input-group-text">/hour</span>
                                </div>
                                <span asp-validation-for="LaborRate" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quote Details -->
                <div class="card mb-4 slide-in-left" style="animation-delay: 0.6s;">
                    <div class="card-header">
                        <h5 class="mb-0">
                            Quote Details
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label asp-for="EstimatedDays" class="form-label"></label>
                                <div class="input-group">
                                    <input asp-for="EstimatedDays" class="form-control" type="number" min="1" />
                                    <span class="input-group-text">days</span>
                                </div>
                                <span asp-validation-for="EstimatedDays" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="ValidUntil" class="form-label"></label>
                                <input asp-for="ValidUntil" class="form-control" type="date" />
                                <span asp-validation-for="ValidUntil" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="WarrantyDays" class="form-label"></label>
                                <div class="input-group">
                                    <input asp-for="WarrantyDays" class="form-control" type="number" min="30" />
                                    <span class="input-group-text">days</span>
                                </div>
                                <span asp-validation-for="WarrantyDays" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label asp-for="AdditionalNotes" class="form-label"></label>
                            <textarea asp-for="AdditionalNotes" class="form-control" rows="3" 
                                     placeholder="Any additional notes or special instructions..."></textarea>
                            <span asp-validation-for="AdditionalNotes" class="text-danger"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Quote Summary -->
            <div class="col-lg-4">
                <div class="card slide-in-right" style="animation-delay: 0.7s;">
                    <div class="card-header">
                        <h5 class="mb-0">
                            Quote Summary
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Cost Breakdown -->
                        <div class="quote-summary">
                            <div class="d-flex justify-content-between py-2 border-bottom">
                                <span>Parts Total:</span>
                                <span class="fw-semibold" id="partsTotal">R0.00</span>
                            </div>
                            <div class="d-flex justify-content-between py-2 border-bottom">
                                <span>Labor Total:</span>
                                <span class="fw-semibold" id="laborTotal">R0.00</span>
                            </div>
                            <div class="d-flex justify-content-between py-2 border-bottom">
                                <span>Subtotal:</span>
                                <span class="fw-semibold" id="subtotal">R0.00</span>
                            </div>
                            <div class="d-flex justify-content-between py-2 border-bottom">
                                <span>VAT (15%):</span>
                                <span class="fw-semibold" id="taxAmount">R0.00</span>
                            </div>
                            <div class="d-flex justify-content-between py-3 bg-light rounded mt-2 px-3">
                                <strong style="color: var(--heading-text);">Total:</strong>
                                <strong class="fs-4" style="color: var(--primary-blue);" id="grandTotal">R0.00</strong>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" name="action" value="generate" class="btn btn-primary">
                                <i class="bi bi-file-text me-1"></i>Generate Quote
                            </button>
                            <button type="submit" name="action" value="send" class="btn btn-primary">
                                <i class="bi bi-envelope me-1"></i>Send to Customer
                            </button>
                        </div>

                        <!-- Quote Info -->
                        <div class="mt-4 pt-3 border-top">
                            <small class="text-muted">
                                <div><strong>Quote #:</strong> QU-@(Model != null ? Model.JobId.ToString() : "NA")-@DateTime.Now.ToString("yyMMdd")</div>
                                <div><strong>Created:</strong> @DateTime.Now.ToString("MMM dd, yyyy")</div>
                                <div><strong>Valid Until:</strong> @(Model != null ? Model.ValidUntil.ToString("MMM dd, yyyy") : "N/A")</div>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Part Item -->
<div id="partTemplate" style="display: none;">
    <div class="part-item border rounded p-3 mb-3 bg-light">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <h6 class="mb-0">Part Item</h6>
            <button type="button" class="btn btn-danger btn-sm remove-part-btn">
                <i class="bi bi-trash"></i>
            </button>
        </div>
        <div class="row g-2">
            <div class="col-md-6">
                <label class="form-label">Part Name *</label>
                <input type="text" class="form-control part-name" placeholder="Screen Assembly" required />
            </div>
            <div class="col-md-6">
                <label class="form-label">Part Number</label>
                <input type="text" class="form-control part-number" placeholder="SCR-IP14-ZA001" />
            </div>
            <div class="col-12">
                <label class="form-label">Description</label>
                <input type="text" class="form-control part-description" placeholder="OLED display with digitizer" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Quantity *</label>
                <input type="number" class="form-control part-quantity" min="1" value="1" required />
            </div>
            <div class="col-md-4">
                <label class="form-label">Unit Price *</label>
                <div class="input-group">
                    <span class="input-group-text">R</span>
                    <input type="number" class="form-control part-price" step="0.01" min="0.01" required />
                </div>
            </div>
            <div class="col-md-4">
                <label class="form-label">Total</label>
                <div class="input-group">
                    <span class="input-group-text">R</span>
                    <input type="text" class="form-control part-total" readonly />
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        let partIndex = 0;

        $(document).ready(function() {
            updateTotals();
            
            // Add part button
            $('#addPartBtn').click(function() {
                addPart();
            });
            
            // Update totals when labor values change
            $('#LaborHours, #LaborRate').on('input', updateTotals);
            
            // Remove part button 
            $(document).on('click', '.remove-part-btn', function() {
                $(this).closest('.part-item').remove();
                updateTotals();
                toggleNoPartsMessage();
            });
            
            // Update part totals when quantity or price changes
            $(document).on('input', '.part-quantity, .part-price', function() {
                updatePartTotal($(this).closest('.part-item'));
                updateTotals();
            });
        });

        function addPart() {
            const template = $('#partTemplate').html();
            const newPart = $(template);
            
            // Update form field names for model binding
            newPart.find('.part-name').attr('name', `Parts[${partIndex}].PartName`);
            newPart.find('.part-number').attr('name', `Parts[${partIndex}].PartNumber`);
            newPart.find('.part-description').attr('name', `Parts[${partIndex}].Description`);
            newPart.find('.part-quantity').attr('name', `Parts[${partIndex}].Quantity`);
            newPart.find('.part-price').attr('name', `Parts[${partIndex}].UnitPrice`);
            
            $('#partsContainer').append(newPart);
            partIndex++;
            
            toggleNoPartsMessage();
        }

        // Update total for a single part item
        function updatePartTotal(partItem) {
            const quantity = parseFloat(partItem.find('.part-quantity').val()) || 0;
            const price = parseFloat(partItem.find('.part-price').val()) || 0;
            const total = quantity * price;
            
            partItem.find('.part-total').val(total.toFixed(2));
        }

        // Update overall totals
        function updateTotals() {
            let partsTotal = 0;
            
            $('.part-item').each(function() {
                const quantity = parseFloat($(this).find('.part-quantity').val()) || 0;
                const price = parseFloat($(this).find('.part-price').val()) || 0;
                partsTotal += quantity * price;
            });
            
            const laborHours = parseFloat($('#LaborHours').val()) || 0;
            const laborRate = parseFloat($('#LaborRate').val()) || 0;
            const laborTotal = laborHours * laborRate;
            
            const subtotal = partsTotal + laborTotal;
            const taxRate = 0.15; // 15% VAT (South African standard rate)
            const taxAmount = subtotal * taxRate;
            const grandTotal = subtotal + taxAmount;
            
            $('#partsTotal').text('R' + partsTotal.toFixed(2));
            $('#laborTotal').text('R' + laborTotal.toFixed(2));
            $('#subtotal').text('R' + subtotal.toFixed(2));
            $('#taxAmount').text('R' + taxAmount.toFixed(2));
            $('#grandTotal').text('R' + grandTotal.toFixed(2));
        }

        // Toggle message when no parts are added
        function toggleNoPartsMessage() {
            const hasParts = $('.part-item').length > 0;
            $('#noPartsMessage').toggle(!hasParts);
        }
    </script>
}