@model SupertronicsRepairSystem.ViewModels.Technician.GenerateRepairQuoteViewModel
@{
    ViewData["Title"] = "Generate Repair Quote";
}

<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4 slide-in-left">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6 fw-bold mb-1" style="color: var(--primary-blue);">
                        Generate Repair Quote
                    </h1>
                    @if (Model != null && !string.IsNullOrEmpty(Model.JobId))
                    {
                        <p class="mb-0" style="color: var(--secondary-text);">For Job #@Model.JobId.Substring(0, 6).ToUpper()</p>
                    }
                </div>
                <div>
                    <a class="btn btn-secondary" asp-action="RepairJobs">
                        <i class="bi bi-arrow-left me-1"></i>Back to Jobs
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="alert alert-info">
        <strong>For Debugging:</strong> The JobId received by this page is: <strong>@(Model.JobId ?? "NULL")</strong>
    </div>

    <form asp-action="GenerateRepairQuote" method="post" id="quoteForm">
        <div asp-validation-summary="All" class="alert alert-danger" role="alert" style="@(ViewData.ModelState.IsValid ? "display: none;" : "")"></div>

        <input type="hidden" name="JobId" value="@Model.JobId" />
        <input type="hidden" name="DeviceName" value="@Model.DeviceName" />
        <input type="hidden" name="ProblemDescription" value="@Model.ProblemDescription" />
        <input type="hidden" name="CustomerName" value="@Model.CustomerName" />
        <input type="hidden" name="SerialNumber" value="@Model.SerialNumber" />

        <div class="row">
            <!-- Left Column - Quote Details -->
            <div class="col-lg-8">

                <!-- Job Information (Read-only) with pure HTML -->
                <div class="card mb-4 fade-in">
                    <div class="card-header"><h5 class="mb-0">Job Information</h5></div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Customer Name</label>
                                <input class="form-control" value="@Model.CustomerName" readonly />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Device/Item</label>
                                <input class="form-control" value="@Model.DeviceName" readonly />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Serial Number</label>
                                <input class="form-control" value="@Model.SerialNumber" readonly />
                            </div>
                            <div class="col-12">
                                <label class="form-label">Problem Description</label>
                                <textarea class="form-control" rows="2" readonly>@Model.ProblemDescription</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Diagnosis and Editable Details -->
                <div class="card mb-4 fade-in">
                    <div class="card-header"><h5 class="mb-0">Diagnosis & Details</h5></div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6"><label asp-for="Brand" class="form-label"></label><input asp-for="Brand" class="form-control" placeholder="e.g., Apple" /></div>
                            <div class="col-md-6"><label asp-for="Model" class="form-label"></label><input asp-for="Model" class="form-control" placeholder="e.g., A2894" /></div>
                            <div class="col-12"><label asp-for="DiagnosisNotes" class="form-label"></label><textarea asp-for="DiagnosisNotes" class="form-control" rows="4" placeholder="Your technical diagnosis and findings..."></textarea></div>
                        </div>
                    </div>
                </div>

                <!-- Parts Required -->
                <div class="card mb-4 slide-in-right">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Required Parts</h5>
                        <button type="button" class="btn btn-primary btn-sm" id="addPartBtn"><i class="bi bi-plus me-1"></i>Add Part</button>
                    </div>
                    <div class="card-body">
                        <div id="partsContainer"></div>
                        <div class="text-muted text-center py-3" id="noPartsMessage">Click "Add Part" to include required parts in the quote</div>
                    </div>
                </div>

                <!-- Labor Information -->
                <div class="card mb-4 fade-in">
                    <div class="card-header"><h5 class="mb-0">Labor Information</h5></div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="LaborHours" class="form-label"></label>
                                <div class="input-group"><input asp-for="LaborHours" class="form-control" type="number" step="0.25" min="0.25" /><span class="input-group-text">hours</span></div>
                                <span asp-validation-for="LaborHours" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="LaborRate" class="form-label"></label>
                                <div class="input-group"><span class="input-group-text">R</span><input asp-for="LaborRate" class="form-control" type="number" step="0.01" min="200" /><span class="input-group-text">/hour</span></div>
                                <span asp-validation-for="LaborRate" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Quote Summary -->
            <div class="col-lg-4">
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header"><h5 class="mb-0">Quote Summary</h5></div>
                    <div class="card-body">
                        <div class="quote-summary">
                            <div class="d-flex justify-content-between py-2 border-bottom"><span>Parts Total:</span><span class="fw-semibold" id="partsTotal">R0.00</span></div>
                            <div class="d-flex justify-content-between py-2 border-bottom"><span>Labor Total:</span><span class="fw-semibold" id="laborTotal">R0.00</span></div>
                            <div class="d-flex justify-content-between py-2 border-bottom"><span>Subtotal:</span><span class="fw-semibold" id="subtotal">R0.00</span></div>
                            <div class="d-flex justify-content-between py-2 border-bottom"><span>VAT (15%):</span><span class="fw-semibold" id="taxAmount">R0.00</span></div>
                            <div class="d-flex justify-content-between py-3 bg-light rounded mt-2 px-3 align-items-center"><strong style="color: var(--heading-text);">Total:</strong><strong class="fs-4" style="color: var(--primary-blue);" id="grandTotal">R0.00</strong></div>
                        </div>
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary"><i class="bi bi-file-text me-1"></i>Generate Quote</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Part Item Template -->
<div id="partTemplate" style="display: none;">
    <div class="part-item border rounded p-3 mb-3 bg-light">
        <div class="d-flex justify-content-between align-items-start mb-3"><h6 class="mb-0">Part Item</h6><button type="button" class="btn btn-danger btn-sm remove-part-btn"><i class="bi bi-trash"></i></button></div>
        <div class="row g-2">
            <div class="col-md-6">
                <label class="form-label">Part Name *</label>
                <input type="text" class="form-control part-name" placeholder="Screen Assembly" />
                <span class="text-danger small part-name-validation" data-valmsg-replace="true"></span>
            </div>
            <div class="col-md-6">
                <label class="form-label">Part Number</label>
                <input type="text" class="form-control part-number" placeholder="SCR-IP14-ZA001" />
            </div>
            <div class="col-12">
                <label class="form-label">Description</label>
                <input type="text" class="form-control part-description" placeholder="OLED display with digitizer" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Quantity *</label>
                <input type="number" class="form-control part-quantity" min="1" value="1" />
                <span class="text-danger small part-quantity-validation" data-valmsg-replace="true"></span>
            </div>
            <div class="col-md-4">
                <label class="form-label">Unit Price *</label>
                <div class="input-group">
                    <span class="input-group-text">R</span>
                    <input type="number" class="form-control part-price" step="0.01" min="0.01" />
                </div>
                <span class="text-danger small part-price-validation" data-valmsg-replace="true"></span>
            </div>
            <div class="col-md-4">
                <label class="form-label">Total</label>
                <div class="input-group">
                    <span class="input-group-text">R</span>
                    <input type="text" class="form-control part-total" readonly />
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        let partIndex = 0;

        $(document).ready(function() {
            updateTotals();
            toggleNoPartsMessage();

            $('#addPartBtn').click(function() {
                addPart();
            });

            $('#LaborHours, #LaborRate').on('input', updateTotals);

            $(document).on('click', '.remove-part-btn', function() {
                $(this).closest('.part-item').remove();
                updateTotals();
                toggleNoPartsMessage();
            });

            $(document).on('input', '.part-quantity, .part-price', function() {
                updatePartTotal($(this).closest('.part-item'));
                updateTotals();
            });
        });

        function addPart() {
            const template = $('#partTemplate').html();
            const newPart = $(template);

            newPart.find('.part-name').attr('name', `Parts[${partIndex}].PartName`);
            newPart.find('.part-number').attr('name', `Parts[${partIndex}].PartNumber`);
            newPart.find('.part-description').attr('name', `Parts[${partIndex}].Description`);
            newPart.find('.part-quantity').attr('name', `Parts[${partIndex}].Quantity`);
            newPart.find('.part-price').attr('name', `Parts[${partIndex}].UnitPrice`);

            newPart.find('.part-name-validation').attr('data-valmsg-for', `Parts[${partIndex}].PartName`);
            newPart.find('.part-quantity-validation').attr('data-valmsg-for', `Parts[${partIndex}].Quantity`);
            newPart.find('.part-price-validation').attr('data-valmsg-for', `Parts[${partIndex}].UnitPrice`);

            $('#partsContainer').append(newPart);

            var form = $("#quoteForm");
            form.removeData("validator");
            form.removeData("unobtrusiveValidation");
            $.validator.unobtrusive.parse(form);

            partIndex++;
            toggleNoPartsMessage();
        }

        function updatePartTotal(partItem) {
            const quantity = parseFloat(partItem.find('.part-quantity').val()) || 0;
            const price = parseFloat(partItem.find('.part-price').val()) || 0;
            const total = quantity * price;
            partItem.find('.part-total').val(total.toFixed(2));
        }

        function updateTotals() {
            let partsTotal = 0;
            $('.part-item').each(function() {
                const quantity = parseFloat($(this).find('.part-quantity').val()) || 0;
                const price = parseFloat($(this).find('.part-price').val()) || 0;
                partsTotal += quantity * price;
            });

            const laborHours = parseFloat($('#LaborHours').val()) || 0;
            const laborRate = parseFloat($('#LaborRate').val()) || 0;
            const laborTotal = laborHours * laborRate;

            const subtotal = partsTotal + laborTotal;
            const taxRate = 0.15;
            const taxAmount = subtotal * taxRate;
            const grandTotal = subtotal + taxAmount;

            $('#partsTotal').text('R' + partsTotal.toFixed(2));
            $('#laborTotal').text('R' + laborTotal.toFixed(2));
            $('#subtotal').text('R' + subtotal.toFixed(2));
            $('#taxAmount').text('R' + taxAmount.toFixed(2));
            $('#grandTotal').text('R' + grandTotal.toFixed(2));
        }

        function toggleNoPartsMessage() {
            const hasParts = $('.part-item').length > 0;
            $('#noPartsMessage').toggle(!hasParts);
        }
    </script>
}